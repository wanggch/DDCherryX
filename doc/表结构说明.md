# 数据库实体与关系分析（基于 ddcherryx.sql）

> 说明：本分析基于你提供的 `ddcherryx.sql` 文件中的 `CREATE TABLE` 与示例数据推断而来，原始 SQL 中基本没有显式 `FOREIGN KEY` 约束，因此大量关系是基于字段命名和业务语义推断的。

---

## 一、核心实体（数据表）概览

### 1. 系统与代码生成相关

| 表名              | 说明                     |
|-------------------|--------------------------|
| `gen_table`       | 代码生成业务表（表级元数据） :contentReference[oaicite:0]{index=0} |
| `gen_table_column`| 代码生成业务字段表（列元数据）:contentReference[oaicite:1]{index=1} |

### 2. 组织与权限体系

| 表名              | 说明 |
|-------------------|------|
| `sys_tenant`      | 租户表，记录租户公司信息、套餐等 :contentReference[oaicite:2]{index=2} |
| `sys_tenant_package` | 租户套餐表，定义菜单权限套餐等 :contentReference[oaicite:3]{index=3} |
| `sys_dept`        | 部门表，树形结构，含上级 `parent_id` :contentReference[oaicite:4]{index=4} |
| `sys_user`        | 用户信息表，关联部门、租户等 :contentReference[oaicite:5]{index=5} |
| `sys_role`        | 角色信息表（角色名称、权限 key、数据范围等）:contentReference[oaicite:6]{index=6} |
| `sys_post`        | 岗位信息表（职位/岗位，关联部门）:contentReference[oaicite:7]{index=7} |
| `sys_user_role`   | 用户与角色关系表（多对多中间表）:contentReference[oaicite:8]{index=8} |
| `sys_user_post`   | 用户与岗位关系表（多对多中间表）:contentReference[oaicite:9]{index=9} |
| `sys_role_dept`   | 角色与部门关系表（数据权限用）:contentReference[oaicite:10]{index=10} |
| `sys_role_menu`   | 角色与菜单关系表（菜单权限）:contentReference[oaicite:11]{index=11} |
| `sys_menu`        | 菜单与路由表，带 `parent_id` 形成菜单树 :contentReference[oaicite:12]{index=12} |

### 3. 产品与类别、文件存储

| 表名                | 说明 |
|---------------------|------|
| `sys_category`      | 产品类别表（可理解为“职位/商品类别”）:contentReference[oaicite:13]{index=13} |
| `sys_product`       | 商品信息表（商品基础信息）:contentReference[oaicite:14]{index=14} |
| `sys_product_detail`| 商品明细表（类似唯一编码/库存明细）:contentReference[oaicite:15]{index=15} |
| `sys_oss`           | 对象存储文件信息表（文件元数据，URL 等）:contentReference[oaicite:16]{index=16} |
| `sys_oss_config`    | 对象存储配置表（MinIO/S3 等配置）:contentReference[oaicite:17]{index=17} |

### 4. 字典、配置、日志、通知等

| 表名              | 说明 |
|-------------------|------|
| `sys_dict_type`   | 字典类型表（字典分类，如性别、状态等）:contentReference[oaicite:18]{index=18} |
| `sys_dict_data`   | 字典数据表（具体字典项）:contentReference[oaicite:19]{index=19} |
| `sys_config`      | 参数配置表（系统配置项）:contentReference[oaicite:20]{index=20} |
| `sys_logininfor`  | 登录日志表（访问记录）:contentReference[oaicite:21]{index=21} |
| `sys_oper_log`    | 操作日志表（接口操作记录）:contentReference[oaicite:22]{index=22} |
| `sys_notice`      | 通知公告表 :contentReference[oaicite:23]{index=23} |
| `sys_client`      | OAuth 客户端配置表（client_id、grant_type 等）:contentReference[oaicite:24]{index=24} |

### 5. 其他业务/辅助表

| 表名            | 说明 |
|-----------------|------|
| `sys_social`    | 第三方社会化账号绑定表（user_id + 第三方信息）:contentReference[oaicite:25]{index=25} |
| `test_demo`     | 测试单表（演示数据权限/审计字段用）:contentReference[oaicite:26]{index=26} |
| `test_tree`     | 测试树表（演示树结构+数据权限）:contentReference[oaicite:27]{index=27} |

---

## 二、表间关系分析

> 说明：以下关系中，若未在 DDL 中显式声明 `FOREIGN KEY`，则是基于字段命名和业务语义推断出的逻辑关系。

### 1. 代码生成模块

| # | 主表           | 关联表             | 关联字段                             | 关系类型       | 简要说明 |
|---|----------------|--------------------|--------------------------------------|----------------|----------|
| 1 | `gen_table`    | `gen_table_column` | `gen_table.table_id = gen_table_column.table_id` :contentReference[oaicite:28]{index=28} | 一对多 | 每一个代码生成业务表（`gen_table`）对应多条字段定义（`gen_table_column`），用于生成 CRUD 代码。 |

---

### 2. 多租户关系

> 多数业务表都有 `tenant_id` 字段（默认值 `'000000'`），用于进行多租户隔离。`sys_tenant.tenant_id` 是强主维度。:contentReference[oaicite:29]{index=29}

典型关系（逻辑）：

| # | 主表        | 关联表                          | 关联字段                                           | 关系类型 | 简要说明 |
|---|-------------|-----------------------------------|----------------------------------------------------|----------|----------|
| 2 | `sys_tenant`| `sys_user` 等所有带 `tenant_id` 的表 | `sys_tenant.tenant_id = <任意表>.tenant_id`        | 一对多   | 一个租户下拥有多个用户、部门、商品等业务数据，形成数据隔离。 |
| 3 | `sys_tenant_package` | `sys_tenant`        | `sys_tenant_package.package_id = sys_tenant.package_id`  | 一对多 | 套餐定义在 `sys_tenant_package` 中，多个租户可共用同一套餐。 |

---

### 3. 组织结构（部门/岗位/用户）

#### 3.1 部门树

| # | 主表      | 关联表   | 关联字段                              | 关系类型 | 简要说明 |
|---|-----------|----------|---------------------------------------|----------|----------|
| 4 | `sys_dept`| `sys_dept` | `sys_dept.parent_id = sys_dept.dept_id`（自关联）:contentReference[oaicite:31]{index=31} | 一对多（树形） | 部门上下级层级结构，实现部门树（公司 → 部门 → 子部门）。 |

#### 3.2 部门与用户/岗位/类别

| # | 主表      | 关联表        | 关联字段                                 | 关系类型 | 简要说明 |
|---|-----------|---------------|------------------------------------------|----------|----------|
| 5 | `sys_dept`| `sys_user`    | `sys_dept.dept_id = sys_user.dept_id` :contentReference[oaicite:32]{index=32} | 一对多 | 一个部门下可以有多个用户。 |
| 6 | `sys_dept`| `sys_post`    | `sys_dept.dept_id = sys_post.dept_id` :contentReference[oaicite:33]{index=33} | 一对多 | 部门下配置多个岗位（职位）。 |
| 7 | `sys_dept`| `sys_category`| `sys_dept.dept_id = sys_category.dept_id` :contentReference[oaicite:34]{index=34} | 一对多 | 部门下配置多个类别（例如职位/商品类别）。 |
| 8 | `sys_dept`| `sys_product` | `sys_dept.dept_id = sys_product.dept_id`（可空）:contentReference[oaicite:35]{index=35} | 一对多 | 商品可归属到某个部门（如业务归属部门）。 |
| 9 | `sys_dept`| `sys_product_detail` | `sys_dept.dept_id = sys_product_detail.dept_id`（可空）:contentReference[oaicite:36]{index=36} | 一对多 | 商品明细也可以按部门归属。 |
| 10 | `sys_dept`| `test_demo`  | `sys_dept.dept_id = test_demo.dept_id` :contentReference[oaicite:37]{index=37} | 一对多 | 测试单表中用于演示数据权限的部门维度。 |
| 11 | `sys_dept`| `test_tree`  | `sys_dept.dept_id = test_tree.dept_id` :contentReference[oaicite:38]{index=38} | 一对多 | 测试树中也带部门维度。 |

#### 3.3 用户与岗位/角色/第三方账号

| # | 主表      | 关联表        | 关联字段                                 | 关系类型   | 简要说明 |
|---|-----------|---------------|------------------------------------------|------------|----------|
| 12 | `sys_user` | `sys_user_post` | `sys_user.user_id = sys_user_post.user_id` :contentReference[oaicite:39]{index=39} | 一对多（到中间表） | 一个用户可关联多个岗位。 |
| 13 | `sys_post` | `sys_user_post` | `sys_post.post_id = sys_user_post.post_id` | 一对多（到中间表） | 一个岗位可分配给多个用户。 |
|    | `sys_user` ↔ `sys_post` | （逻辑多对多） | 通过 `sys_user_post` 连接 | 多对多 | 用户与岗位是多对多关系。 |
| 14 | `sys_user` | `sys_user_role` | `sys_user.user_id = sys_user_role.user_id` :contentReference[oaicite:40]{index=40} | 一对多（到中间表） | 一个用户可拥有多个角色。 |
| 15 | `sys_role` | `sys_user_role` | `sys_role.role_id = sys_user_role.role_id` | 一对多（到中间表） | 一个角色可分配给多个用户。 |
|    | `sys_user` ↔ `sys_role` | （逻辑多对多） | 通过 `sys_user_role` 连接 | 多对多 | 用户与角色多对多，控制权限。 |
| 16 | `sys_user` | `sys_social`    | `sys_user.user_id = sys_social.user_id` :contentReference[oaicite:41]{index=41} | 一对多 | 一个系统用户可绑定多个第三方账号（微信/钉钉等）。 |
| 17 | `sys_user` | `test_demo`     | `sys_user.user_id = test_demo.user_id`（测试字段）:contentReference[oaicite:42]{index=42} | 一对多 | 演示多表数据权限（用户维度）。 |
| 18 | `sys_user` | `test_tree`     | `sys_user.user_id = test_tree.user_id` :contentReference[oaicite:43]{index=43} | 一对多 | 测试树数据的责任人 / 所属用户。 |

#### 3.4 角色与部门/菜单（数据权限 & 菜单权限）

| # | 主表      | 关联表         | 关联字段                              | 关系类型   | 简要说明 |
|---|-----------|----------------|---------------------------------------|------------|----------|
| 19 | `sys_role` | `sys_role_dept` | `sys_role.role_id = sys_role_dept.role_id` :contentReference[oaicite:44]{index=44} | 一对多（到中间表） | 定义角色可以访问哪些部门数据。 |
| 20 | `sys_dept` | `sys_role_dept` | `sys_dept.dept_id = sys_role_dept.dept_id` | 一对多（到中间表） | 一个部门可被多个角色授予权限。 |
|    | `sys_role` ↔ `sys_dept` | （逻辑多对多） | 通过 `sys_role_dept` 连接 | 多对多 | 角色与部门间多对多关系。 |
| 21 | `sys_role` | `sys_role_menu` | `sys_role.role_id = sys_role_menu.role_id` :contentReference[oaicite:45]{index=45} | 一对多（到中间表） | 一个角色可配置多个菜单权限。 |
| 22 | `sys_menu` | `sys_role_menu` | `sys_menu.menu_id = sys_role_menu.menu_id` | 一对多（到中间表） | 一个菜单可被多个角色引用。 |
|    | `sys_role` ↔ `sys_menu` | （逻辑多对多） | 通过 `sys_role_menu` 连接 | 多对多 | 角色与菜单是多对多权限关系。 |
| 23 | `sys_menu` | `sys_menu`     | `sys_menu.parent_id = sys_menu.menu_id`（自关联）:contentReference[oaicite:46]{index=46} | 一对多（树形） | 菜单树结构（目录/菜单/按钮）。 |

---

### 4. 产品体系与文件存储

| # | 主表           | 关联表             | 关联字段                                  | 关系类型 | 简要说明 |
|---|----------------|--------------------|-------------------------------------------|----------|----------|
| 24 | `sys_category`| `sys_product`      | `sys_category.category_id = sys_product.category_id` :contentReference[oaicite:47]{index=47} | 一对多 | 一个类别下有多个商品。 |
| 25 | `sys_product` | `sys_product_detail` | `sys_product.product_id = sys_product_detail.product_id` :contentReference[oaicite:48]{index=48} | 一对多 | 一个商品有多条明细记录（不同唯一编码/库存明细）。 |
| 26 | `sys_oss`     | `sys_product`      | `sys_oss.oss_id = sys_product.oss_id`（推断） | 一对多 | 一个 OSS 文件记录可被多个商品引用（共享图片），或通常一对一作为商品主图。 |
| 27 | `sys_oss_config` | `sys_oss`       | 通过 `tenant_id` 和 `config_key/service`（逻辑关联） | 一对多（逻辑） | 一个对象存储配置下可存储多条文件记录。 |

---

### 5. 字典、配置与日志

#### 5.1 字典类型与字典数据

| # | 主表          | 关联表        | 关联字段                                                       | 关系类型 | 简要说明 |
|---|---------------|---------------|----------------------------------------------------------------|----------|----------|
| 28 | `sys_dict_type` | `sys_dict_data` | `sys_dict_type.dict_type = sys_dict_data.dict_type` 且同一 `tenant_id`  | 一对多 | 一个字典类型（如 `sys_user_sex`）下面包含多条字典数据（男/女/未知）。 |

#### 5.2 配置、日志、通知等与用户/租户的逻辑关系

这些表中普遍存在：

- `tenant_id`：逻辑关联到 `sys_tenant.tenant_id`。
- `create_by` / `update_by`：逻辑上对应 `sys_user.user_id`。
- `create_dept`：逻辑上对应 `sys_dept.dept_id`。

| # | 主表          | 关联表    | 关联字段                                | 关系类型 | 简要说明 |
|---|---------------|-----------|-----------------------------------------|----------|----------|
| 29 | `sys_config` | `sys_tenant` | `sys_config.tenant_id = sys_tenant.tenant_id`（逻辑） | 一对多 | 每个租户拥有独立的配置参数。 |
| 30 | `sys_logininfor` | `sys_user` | `sys_logininfor.user_name` 对应 `sys_user.user_name`（逻辑） | 一对多 | 记录某个账号的登录历史。 |
| 31 | `sys_oper_log` | `sys_user`/`sys_dept` | `oper_name`、`dept_name` 与用户/部门名称对应（逻辑）:contentReference[oaicite:53]{index=53} | 一对多 | 记录某个用户对系统的操作行为。 |
| 32 | `sys_notice` | `sys_user`/`sys_dept` | `create_by`、`create_dept` 等（逻辑）:contentReference[oaicite:54]{index=54} | 一对多 | 通知的发布者和发布部门。 |
| 33 | `sys_client` | `sys_logininfor` | `client_key` 与 `device_type` 字段（逻辑） | 一对多 | 某个 OAuth 客户端下产生多条登录记录。 |

> 注：上述均属于“弱关系”（未通过 id 强制约束），更多是通过业务层控制的一致性。

---

### 6. 测试/演示表之间的关系

| # | 主表      | 关联表     | 关联字段                                           | 关系类型 | 说明 |
|---|-----------|------------|----------------------------------------------------|----------|------|
| 34 | `test_demo` | `sys_dept` | `dept_id`                                          | 一对多 | 演示“单表 + 部门维度”的数据权限。 |
| 35 | `test_demo` | `sys_user` | `user_id`                                          | 一对多 | 演示“单表 + 用户维度”的数据权限。 |
| 36 | `test_tree` | `test_tree`| `parent_id = id`（自关联）:contentReference[oaicite:56]{index=56} | 一对多（树） | 测试树结构。 |
| 37 | `test_tree` | `sys_dept` | `dept_id`                                          | 一对多 | 测试树 + 部门数据权限。 |
| 38 | `test_tree` | `sys_user` | `user_id`                                          | 一对多 | 测试树 + 用户数据权限。 |

---

## 三、实体关系图（Mermaid ER Diagram）

> 为避免图过于复杂，ERD 主要展示**强关系**（主键/外键风格的 ID 关联、自引用、典型中间表等）。  
> 公共审计字段（`create_by`, `update_by`, `create_dept`, `tenant_id` 等）在图中不一一画出，但在上文已说明其逻辑关系。

```mermaid
erDiagram

    %% ========= 核心组织、权限 =========
    SYS_TENANT {
        bigint id PK
        varchar tenant_id
        bigint package_id
    }

    SYS_TENANT_PACKAGE {
        bigint package_id PK
    }

    SYS_DEPT {
        bigint dept_id PK
        bigint parent_id
    }

    SYS_USER {
        bigint user_id PK
        bigint dept_id
        varchar tenant_id
        bigint avatar
    }

    SYS_ROLE {
        bigint role_id PK
        varchar role_key
    }

    SYS_POST {
        bigint post_id PK
        bigint dept_id
    }

    SYS_MENU {
        bigint menu_id PK
        bigint parent_id
    }

    SYS_USER_ROLE {
        bigint user_id PK
        bigint role_id PK
    }

    SYS_USER_POST {
        bigint user_id PK
        bigint post_id PK
    }

    SYS_ROLE_DEPT {
        bigint role_id PK
        bigint dept_id PK
    }

    SYS_ROLE_MENU {
        bigint role_id PK
        bigint menu_id PK
    }

    SYS_SOCIAL {
        bigint id PK
        bigint user_id
    }

    %% ========= 字典、配置 =========
    SYS_DICT_TYPE {
        bigint dict_id PK
        varchar dict_type
    }

    SYS_DICT_DATA {
        bigint dict_code PK
        varchar dict_type
    }

    SYS_CONFIG {
        bigint config_id PK
    }

    %% ========= 产品与文件 =========
    SYS_CATEGORY {
        bigint category_id PK
        bigint dept_id
    }

    SYS_PRODUCT {
        bigint product_id PK
        bigint category_id
        bigint oss_id
        bigint dept_id
    }

    SYS_PRODUCT_DETAIL {
        bigint detail_id PK
        bigint product_id
        bigint dept_id
    }

    SYS_OSS {
        bigint oss_id PK
    }

    SYS_OSS_CONFIG {
        bigint oss_config_id PK
        varchar config_key
    }

    %% ========= 日志、通知、客户端 =========
    SYS_CLIENT {
        bigint id PK
        varchar client_id
        varchar client_key
    }

    SYS_LOGININFOR {
        bigint info_id PK
        varchar user_name
        varchar client_key
    }

    SYS_OPER_LOG {
        bigint oper_id PK
    }

    SYS_NOTICE {
        bigint notice_id PK
    }

    %% ========= 代码生成 =========
    GEN_TABLE {
        bigint table_id PK
    }

    GEN_TABLE_COLUMN {
        bigint column_id PK
        bigint table_id
    }

    %% ========= 测试表 =========
    TEST_DEMO {
        bigint id PK
        bigint dept_id
        bigint user_id
    }

    TEST_TREE {
        bigint id PK
        bigint parent_id
        bigint dept_id
        bigint user_id
    }

    %% ===== 租户与套餐 =====
    SYS_TENANT_PACKAGE ||--o{ SYS_TENANT : "套餐-租户(1:N)"
    SYS_TENANT ||--o{ SYS_USER : "租户-用户(1:N)"
    SYS_TENANT ||--o{ SYS_DEPT : "租户-部门(1:N)"

    %% ===== 部门树、自引用 =====
    SYS_DEPT ||--o{ SYS_DEPT : "parent_id(树)"

    %% ===== 用户-部门-岗位 =====
    SYS_DEPT ||--o{ SYS_USER : "部门-用户"
    SYS_DEPT ||--o{ SYS_POST : "部门-岗位"
    SYS_POST ||--o{ SYS_USER_POST : "岗位-用户岗位"
    SYS_USER ||--o{ SYS_USER_POST : "用户-用户岗位"

    %% ===== 用户-角色 =====
    SYS_USER ||--o{ SYS_USER_ROLE : "用户-用户角色"
    SYS_ROLE ||--o{ SYS_USER_ROLE : "角色-用户角色"

    %% ===== 角色-部门 / 角色-菜单 =====
    SYS_ROLE ||--o{ SYS_ROLE_DEPT : "角色-角色部门"
    SYS_DEPT ||--o{ SYS_ROLE_DEPT : "部门-角色部门"
    SYS_ROLE ||--o{ SYS_ROLE_MENU : "角色-角色菜单"
    SYS_MENU ||--o{ SYS_ROLE_MENU : "菜单-角色菜单"

    %% ===== 菜单树 =====
    SYS_MENU ||--o{ SYS_MENU : "parent_id(树)"

    %% ===== 社会化账号 =====
    SYS_USER ||--o{ SYS_SOCIAL : "用户-社交账号"

    %% ===== 字典 =====
    SYS_DICT_TYPE ||--o{ SYS_DICT_DATA : "字典类型-字典数据"

    %% ===== 产品体系 =====
    SYS_DEPT ||--o{ SYS_CATEGORY : "部门-类别"
    SYS_CATEGORY ||--o{ SYS_PRODUCT : "类别-商品"
    SYS_PRODUCT ||--o{ SYS_PRODUCT_DETAIL : "商品-明细"
    SYS_DEPT ||--o{ SYS_PRODUCT_DETAIL : "部门-商品明细"
    SYS_OSS ||--o{ SYS_PRODUCT : "文件-商品图片(推断)"

    %% ===== 文件配置 =====
    SYS_OSS_CONFIG ||--o{ SYS_OSS : "配置-文件(逻辑)"

    %% ===== 登录、客户端 =====
    SYS_CLIENT ||--o{ SYS_LOGININFOR : "客户端-登录记录(逻辑)"

    %% ===== 代码生成 =====
    GEN_TABLE ||--o{ GEN_TABLE_COLUMN : "生成表-字段"

    %% ===== 测试表关系 =====
    SYS_DEPT ||--o{ TEST_DEMO : "部门-测试单表"
    SYS_USER ||--o{ TEST_DEMO : "用户-测试单表"
    TEST_TREE ||--o{ TEST_TREE : "parent_id(树)"
    SYS_DEPT ||--o{ TEST_TREE : "部门-测试树"
    SYS_USER ||--o{ TEST_TREE : "用户-测试树"
